<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>2D マイクラ風ゲーム</title>
    <style>
        body { margin: 0; }
        canvas { touch-action: none; }
        #controls { position: absolute; bottom: 10px; left: 10px; }
        button { margin: 5px; padding: 10px; }
        #inventory { position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; border-radius: 5px; }
        #inventory ul { list-style-type: none; margin: 0; padding: 0; }
        #inventory li { margin: 5px 0; cursor: pointer; }
        #inventory li.selected { background: rgba(255, 255, 255, 0.3); }
        #sky { position: absolute; top: 0; left: 0; width: 100%; height: 100px; background: lightblue; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="sky"></div>
<div id="controls">
    <button id="left">左</button>
    <button id="right">右</button>
    <button id="up">上</button>
    <button id="down">下</button>
    <button id="toggle">配置/破壊切替</button>
    <button id="craft">クラフト</button>
</div>
<div id="inventory">
    <h3>インベントリ</h3>
    <ul id="inventory-list"></ul>
</div>
<script>
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
    scene: { preload, create, update }
};

const game = new Phaser.Game(config);
let player, cursors, blocks, weapon, placing = true, enemies, cooperators, spawnEggs, inventory = {};
const materials = {
    'dirt': { image: 'dirt', strength: 1 },
    'grass': { image: 'grass', strength: 1 },
    'wood': { image: 'wood', strength: 2 },
    'stone': { image: 'stone', strength: 3 },
    'iron': { image: 'iron', strength: 4 },
    'gold': { image: 'gold', strength: 5 },
    'fluorite': { image: 'fluorite', strength: 6 },
    'water': { image: 'water', strength: 0, liquid: true },
    'lava': { image: 'lava', strength: 0, liquid: true },
    'cardboard': { image: 'cardboard', strength: 0.5 },
    'wipe': { image: 'wipe', strength: 10 }, // ワイパー追加
    'momonga_ore': { image: 'momonga_ore', strength: 1 }, // モモンガ鉱石追加
    'triangle_enemy_egg': { image: 'triangle_enemy_egg', strength: 0 }, // 三角形の敵スポーンエッグ追加
    'octagon_enemy_egg': { image: 'octagon_enemy_egg', strength: 0 } // 八角形の敵スポーンエッグ追加
};

const recipes = {
    'wood_sword': { 'wood': 2 },
    'stone_sword': { 'stone': 2 },
    'iron_sword': { 'iron': 2 },
    'gold_sword': { 'gold': 2 },
    'fluorite_sword': { 'fluorite': 2 },
    'cardboard': { 'wood': 1, quantity: 8 },
    'wipe': { 'wood': 2, 'iron': 1 }, // ワイパーのレシピ
    'momonga_spawn': { 'momonga_ore': 1 }, // モモンガのレシピ
    'triangle_enemy_egg': { 'stone': 1 }, // 三角形の敵スポーンエッグのレシピ
    'octagon_enemy_egg': { 'iron': 1 } // 八角形の敵スポーンエッグのレシピ
};

function preload() {
    // 画像の読み込み
    this.load.image('player', 'https://examples.phaser.io/assets/sprites/phaser-dude.png'); // プレイヤーの仮画像
    this.load.image('dirt', 'image/dirt.png');
    this.load.image('grass', 'image/grass.png');
    this.load.image('wood', 'image/wood.png');
    this.load.image('stone', 'image/stone.png');
    this.load.image('iron', 'image/iron.png');
    this.load.image('gold', 'image/gold.png');
    this.load.image('fluorite', 'image/fluorite.png');
    this.load.image('water', 'image/water.png');
    this.load.image('lava', 'image/lava.png');
    this.load.image('cardboard', 'image/cardboard.png');
    this.load.image('wipe', 'image/wipe.png'); // ワイパーの画像追加
    this.load.image('momonga', 'image/momonga.png'); // ちいかわのモモンガの画像
    this.load.image('triangle_enemy', 'image/triangle_enemy.png'); // 三角形の敵の画像
    this.load.image('octagon_enemy', 'image/octagon_enemy.png'); // 八角形の敵の画像
    this.load.image('momonga_ore', 'image/momonga_ore.png'); // モモンガ鉱石の画像
    this.load.image('triangle_enemy_egg', 'image/triangle_enemy_egg.png'); // 三角形の敵スポーンエッグの画像
    this.load.image('octagon_enemy_egg', 'image/octagon_enemy_egg.png'); // 八角形の敵スポーンエッグの画像
}

function create() {
    // プレイヤーを青い丸に変更
    player = this.add.circle(100, 100, 16, 0x0000ff).setOrigin(0.5).setDepth(1);
    this.physics.world.enable(player);
    player.body.setCollideWorldBounds(true);

    blocks = this.physics.add.staticGroup();
    enemies = this.physics.add.group();
    cooperators = this.physics.add.group();
    spawnEggs = this.physics.add.group(); // スポーンエッグのグループ
    weapon = this.add.image(0, 0, 'wipe').setScale(0.5).setVisible(false); // ワイパーを武器として設定
    cursors = this.input.keyboard.createCursorKeys();

    // 土と石の生成
    for (let y = 100; y < window.innerHeight; y += 32) {
        for (let x = 0; x < window.innerWidth; x += 32) {
            let material = 'dirt';
            if (y > window.innerHeight * 0.75 && Math.random() < 0.1) material = 'iron';
            else if (y > window.innerHeight * 0.85 && Math.random() < 0.05) material = 'gold';
            else if (y > window.innerHeight * 0.9 && Math.random() < 0.01) material = 'fluorite';
            else if (y > window.innerHeight / 2 - 32) material = 'grass';
            blocks.create(x, y, materials[material].image).setScale(2);
            updateInventory(material, 1);
        }
    }

    // 木の生成
    for (let i = 0; i < 5; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = window.innerHeight / 2 - 32;
        generateTree(x, y);
    }

    // 水とマグマの生成
    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['water'].image).setScale(2);
    }
    for (let i = 0; i < 2; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['lava'].image).setScale(2);
    }

    // 敵スポーンエッグの配置
    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(0, window.innerHeight / 2);
        spawnEggs.create(x, y, 'triangle_enemy_egg').setScale(0.5);
    }
    for (let i = 0; i < 2; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(0, window.innerHeight / 2);
        spawnEggs.create(x, y, 'octagon_enemy_egg').setScale(0.5);
    }

    // モモンガの配置
    for (let i = 0; i < 1; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(0, window.innerHeight / 2);
        cooperators.create(x, y, 'momonga').setScale(0.5).setData('hp', 10);
    }

    // クラフトメニューの表示
    displayCraftMenu();
    updateInventoryList();

    // 敵の動きの設定
    this.physics.add.collider(player, enemies, (player, enemy) => {
        player.setTint(0xff0000);
        player.body.setVelocity(0);
    });
}

function update() {
    // プレイヤーの移動
    if (cursors.left.isDown) player.x -= 5;
    if (cursors.right.isDown) player.x += 5;
    if (cursors.up.isDown) player.y -= 5;
    if (cursors.down.isDown) player.y += 5;

    // 武器の位置をプレイヤーに合わせる
    weapon.setPosition(player.x, player.y);

    if (cursors.space.isDown) {
        if (placing) {
            placeBlock();
        } else {
            destroyBlock();
        }
    }

    // モモンガの攻撃処理
    cooperators.getChildren().forEach(momonga => {
        const enemiesInRange = enemies.getChildren().filter(enemy => Phaser.Math.Distance.Between(momonga.x, momonga.y, enemy.x, enemy.y) < 100);
        if (enemiesInRange.length > 0) {
            enemiesInRange.forEach(enemy => {
                if (momonga.getData('hp') > 0) {
                    // モモンガが敵に攻撃する処理
                    momonga.setTint(0xff0000); // 攻撃状態を示す
                    enemy.setData('hp', enemy.getData('hp') - 5); // 攻撃力は5とする
                    if (enemy.getData('hp') <= 0) {
                        enemy.destroy();
                        updateInventory('triangle_enemy_egg', 1); // 三角形の敵が消えたときスポーンエッグを追加
                    }
                }
            });
        }
    });

    // 敵の行動
    enemies.getChildren().forEach(enemy => {
        enemy.setVelocityY(Phaser.Math.Between(-50, 50));
        enemy.setVelocityX(Phaser.Math.Between(-50, 50));
    });
}

// ブロックを設置
function placeBlock() {
    if (currentMaterial) {
        const x = Math.floor(player.x / 32) * 32;
        const y = Math.floor(player.y / 32) * 32;
        if (!blocks.getChildren().find(b => b.x === x && b.y === y)) {
            blocks.create(x, y, materials[currentMaterial].image).setScale(2);
            updateInventory(currentMaterial, -1);
        }
    }
}

// ブロックを破壊
function destroyBlock() {
    const x = Math.floor(player.x / 32) * 32;
    const y = Math.floor(player.y / 32) * 32;
    const block = blocks.getChildren().find(b => b.x === x && b.y === y);
    if (block) {
        updateInventory(materials[block.texture.key].image, 1);
        block.destroy();
    }
}

// プレイヤーの周りのブロックを配置
function generateTree(x, y) {
    blocks.create(x, y, 'wood').setScale(2);
    for (let i = 1; i <= 3; i++) {
        blocks.create(x, y - (i * 32), 'wood').setScale(2);
    }
}

// インベントリを更新
function updateInventory(item, quantity) {
    if (!inventory[item]) {
        inventory[item] = 0;
    }
    inventory[item] += quantity;
    if (inventory[item] <= 0) {
        delete inventory[item];
    }
    updateInventoryList();
}

// インベントリリストの更新
function updateInventoryList() {
    const inventoryList = document.getElementById('inventory-list');
    inventoryList.innerHTML = '';
    for (const [item, quantity] of Object.entries(inventory)) {
        const li = document.createElement('li');
        li.textContent = `${item}: ${quantity}`;
        li.dataset.item = item;
        inventoryList.appendChild(li);
    }
}

// クラフトメニューの表示
function displayCraftMenu() {
    const craftButton = document.getElementById('craft');
    craftButton.addEventListener('click', () => {
        const item = prompt('クラフトしたいアイテムを入力してください (例: wood_sword)');
        if (recipes[item]) {
            let canCraft = true;
            for (const [material, qty] of Object.entries(recipes[item])) {
                if ((material === 'quantity' && qty > 0) || (inventory[material] || 0) < qty) {
                    canCraft = false;
                    break;
                }
            }
            if (canCraft) {
                for (const [material, qty] of Object.entries(recipes[item])) {
                    if (material !== 'quantity') {
                        updateInventory(material, -qty);
                    }
                }
                updateInventory(item, 1);
                alert(`${item} を作成しました`);
            } else {
                alert('素材が不足しています');
            }
        } else {
            alert('不正なアイテムです');
        }
    });
}

// 配置/破壊切替ボタンの処理
document.getElementById('toggle').addEventListener('click', () => {
    placing = !placing;
    const state = placing ? '配置モード' : '破壊モード';
    alert(`現在は ${state} です`);
});
</script>
</body>
</html>
