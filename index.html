<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>2D マイクラ風ゲーム</title>
    <style>
        body { margin: 0; }
        canvas { touch-action: none; }
        #controls { position: absolute; bottom: 10px; left: 10px; }
        button { margin: 5px; padding: 10px; }
        #inventory { position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; border-radius: 5px; }
        #inventory ul { list-style-type: none; margin: 0; padding: 0; }
        #inventory li { margin: 5px 0; cursor: pointer; }
        #inventory li.selected { background: rgba(255, 255, 255, 0.3); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="controls">
    <button id="left">左</button>
    <button id="right">右</button>
    <button id="up">上</button>
    <button id="down">下</button>
    <button id="toggle">配置/破壊切替</button>
    <button id="craft">クラフト</button>
</div>
<div id="inventory">
    <h3>インベントリ</h3>
    <ul id="inventory-list"></ul>
</div>
<script>
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
    scene: { preload, create, update }
};

const game = new Phaser.Game(config);
let player, cursors, blocks, weapon, placing = true, enemies, cooperators, inventory = {};
const materials = {
    'dirt': { image: 'dirt', strength: 1 },
    'grass': { image: 'grass', strength: 1 },
    'wood': { image: 'wood', strength: 2 },
    'stone': { image: 'stone', strength: 3 },
    'iron': { image: 'iron', strength: 4 },
    'gold': { image: 'gold', strength: 5 },
    'fluorite': { image: 'fluorite', strength: 6 },
    'water': { image: 'water', strength: 0, liquid: true },
    'lava': { image: 'lava', strength: 0, liquid: true },
    'cardboard': { image: 'cardboard', strength: 0.5 },
    'wipe': { image: 'wipe', strength: 10 } // ワイパー追加
};

const recipes = {
    'wood_sword': { 'wood': 2 },
    'stone_sword': { 'stone': 2 },
    'iron_sword': { 'iron': 2 },
    'gold_sword': { 'gold': 2 },
    'fluorite_sword': { 'fluorite': 2 },
    'cardboard': { 'wood': 1, quantity: 8 },
    'wipe': { 'wood': 2, 'iron': 1 } // ワイパーのレシピ
};

function preload() {
    // 画像の読み込み
    this.load.image('player', 'https://examples.phaser.io/assets/sprites/phaser-dude.png'); // プレイヤーの仮画像
    this.load.image('dirt', 'image/dirt.png');
    this.load.image('grass', 'image/grass.png');
    this.load.image('wood', 'image/wood.png');
    this.load.image('stone', 'image/stone.png');
    this.load.image('iron', 'image/iron.png');
    this.load.image('gold', 'image/gold.png');
    this.load.image('fluorite', 'image/fluorite.png');
    this.load.image('water', 'image/water.png');
    this.load.image('lava', 'image/lava.png');
    this.load.image('cardboard', 'image/cardboard.png');
    this.load.image('wipe', 'image/wiper.png'); // ワイパーの画像追加
    this.load.image('momonga', 'image/momonga.png'); // ちいかわのモモンガの画像
    this.load.image('triangle_enemy', 'image/triangle_enemy.png'); // 三角形の敵の画像
}

function create() {
    // プレイヤーを青い丸に変更
    player = this.add.circle(100, 100, 16, 0x0000ff).setOrigin(0.5).setDepth(1);
    this.physics.world.enable(player);
    player.body.setCollideWorldBounds(true);

    blocks = this.physics.add.staticGroup();
    enemies = this.physics.add.group();
    cooperators = this.physics.add.group();
    weapon = this.add.image(0, 0, 'wipe').setScale(0.5).setVisible(false); // ワイパーを武器として設定
    cursors = this.input.keyboard.createCursorKeys();

    // 土と石の生成
    for (let y = 0; y < window.innerHeight; y += 32) {
        for (let x = 0; x < window.innerWidth; x += 32) {
            let material = 'dirt';
            if (y > window.innerHeight * 0.75 && Math.random() < 0.1) material = 'iron';
            else if (y > window.innerHeight * 0.85 && Math.random() < 0.05) material = 'gold';
            else if (y > window.innerHeight * 0.9 && Math.random() < 0.01) material = 'fluorite';
            else if (y > window.innerHeight / 2 - 32) material = 'grass';
            blocks.create(x, y, materials[material].image).setScale(2);
            updateInventory(material, 1);
        }
    }

    // 木の生成
    for (let i = 0; i < 5; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = window.innerHeight / 2 - 32;
        generateTree(x, y);
    }

    // 水とマグマの生成
    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['water'].image).setScale(2);
    }
    for (let i = 0; i < 2; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['lava'].image).setScale(2);
    }

    // ちいかわのモモンガのスポーン
    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(0, window.innerHeight / 2);
        cooperators.create(x, y, 'momonga').setScale(0.5).setData('hp', 18);
    }

    // 三角形の敵のスポーン
    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        enemies.create(x, y, 'triangle_enemy').setScale(0.5).setData('hp', 10);
    }

    this.input.on('pointerdown', (pointer) => {
        const x = Math.floor(pointer.x / 32) * 32;
        const y = Math.floor(pointer.y / 32) * 32;
        if (placing) {
            blocks.create(x, y, 'dirt').setScale(2);
            updateInventory('dirt', 1);
        } else {
            destroyBlock(x, y);
        }
    });

    // インベントリの表示
    updateInventoryDisplay();

    // ボタンイベントリスナー
    document.getElementById('left').addEventListener('click', () => movePlayer(-32, 0));
    document.getElementById('right').addEventListener('click', () => movePlayer(32, 0));
    document.getElementById('up').addEventListener('click', () => movePlayer(0, -32));
    document.getElementById('down').addEventListener('click', () => movePlayer(0, 32));
    document.getElementById('toggle').addEventListener('click', () => placing = !placing);
    document.getElementById('craft').addEventListener('click', () => showCraftingMenu());

    // スプラトゥーン風のワイパー追加
    this.input.on('pointermove', (pointer) => {
        if (weapon.visible) {
            weapon.setPosition(pointer.x, pointer.y);
        }
    });
}

function update() {
    if (cursors.left.isDown) {
        movePlayer(-4, 0);
    } else if (cursors.right.isDown) {
        movePlayer(4, 0);
    }
    if (cursors.up.isDown) {
        movePlayer(0, -4);
    } else if (cursors.down.isDown) {
        movePlayer(0, 4);
    }
}

function movePlayer(dx, dy) {
    player.x += dx;
    player.y += dy;
}

function generateTree(x, y) {
    const height = Phaser.Math.Between(3, 5);
    for (let i = 0; i < height; i++) {
        blocks.create(x, y - i * 32, 'wood').setScale(2);
        updateInventory('wood', 1);
    }
}

function destroyBlock(x, y) {
    const block = blocks.getChildren().find(b => b.x === x && b.y === y);
    if (block) {
        const material = Object.keys(materials).find(key => materials[key].image === block.texture.key);
        if (material) {
            const dropItem = Phaser.Math.Between(1, 100) <= 30; // 30%の確率でアイテムをドロップ
            if (dropItem) {
                updateInventory(material, 1);
            }
            block.destroy();
        }
    }
}

function updateInventory(material, quantity) {
    if (!inventory[material]) {
        inventory[material] = 0;
    }
    inventory[material] += quantity;
    updateInventoryDisplay();
}

function updateInventoryDisplay() {
    const inventoryList = document.getElementById('inventory-list');
    inventoryList.innerHTML = '';
    for (const [material, quantity] of Object.entries(inventory)) {
        const li = document.createElement('li');
        li.textContent = `${material}: ${quantity}`;
        inventoryList.appendChild(li);
    }
}

function showCraftingMenu() {
    const recipe = prompt('クラフトするアイテムを入力してください (例: wood_sword):');
    if (recipes[recipe]) {
        let canCraft = true;
        for (const [material, quantity] of Object.entries(recipes[recipe])) {
            if (material !== 'quantity' && (!inventory[material] || inventory[material] < quantity)) {
                canCraft = false;
                break;
            }
        }
        if (canCraft) {
            for (const [material, quantity] of Object.entries(recipes[recipe])) {
                if (material !== 'quantity') {
                    inventory[material] -= quantity;
                }
            }
            updateInventoryDisplay();
            alert(`クラフト成功！${recipe}を作成しました。`);
        } else {
            alert('材料が足りません。');
        }
    } else {
        alert('無効なレシピです。');
    }
}
</script>
</body>
</html>
