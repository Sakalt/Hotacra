<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>2D マイクラ風ゲーム</title>
    <style>
        body { margin: 0; }
        canvas { touch-action: none; }
        #controls { position: absolute; bottom: 10px; left: 10px; }
        button { margin: 5px; padding: 10px; }
        #inventory { position: absolute; bottom: 10px; right: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px; border-radius: 5px; }
        #inventory ul { list-style-type: none; margin: 0; padding: 0; }
        #inventory li { margin: 5px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>
<div id="controls">
    <button id="left">左</button>
    <button id="right">右</button>
    <button id="up">上</button>
    <button id="down">下</button>
    <button id="toggle">配置/破壊切替</button>
    <button id="craft">クラフト</button>
</div>
<div id="inventory">
    <h3>インベントリ</h3>
    <ul id="inventory-list"></ul>
</div>
<script>
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade', arcade: { gravity: { y: 0 } } },
    scene: { preload, create, update }
};

const game = new Phaser.Game(config);
let player, cursors, blocks, weapon, placing = true, enemies, inventory = {}, currentWeapon = null;
const materials = {
    'dirt': { image: 'dirt', strength: 1 },
    'grass': { image: 'grass', strength: 1 },
    'wood': { image: 'wood', strength: 2 },
    'stone': { image: 'stone', strength: 3 },
    'iron': { image: 'iron', strength: 4 },
    'gold': { image: 'gold', strength: 5 },
    'fluorite': { image: 'fluorite', strength: 6 },
    'water': { image: 'water', strength: 0, liquid: true },
    'lava': { image: 'lava', strength: 0, liquid: true },
    'cardboard': { image: 'cardboard', strength: 0.5 }
};

const recipes = {
    'wood_sword': { 'wood': 2 },
    'stone_sword': { 'stone': 2 },
    'iron_sword': { 'iron': 2 },
    'gold_sword': { 'gold': 2 },
    'Wiper': { 'iron': 3, 'gold': 1 },
    'cardboard': { 'wood': 8 }
};

function preload() {
    this.load.image('player', 'https://examples.phaser.io/assets/sprites/phaser-dude.png');
    this.load.image('dirt', 'image/dirt.png');
    this.load.image('grass', 'image/grass.png');
    this.load.image('wood', 'image/wood.png');
    this.load.image('stone', 'image/stone.png');
    this.load.image('iron', 'image/iron.png');
    this.load.image('fluorite', 'image/fluorite.png');
    this.load.image('water', 'image/water.png');
    this.load.image('lava', 'image/lava.png');
    this.load.image('cardboard', 'image/cardboard.png');
    this.load.image('momonga', 'image/momonga.png');
    this.load.image('sword', 'image/sword.png');
    this.load.image('Wiper', 'image/Wiper.png');
}

function create() {
    player = this.physics.add.sprite(100, 100, 'player').setCollideWorldBounds(true);
    blocks = this.physics.add.staticGroup();
    enemies = this.physics.add.group();
    weapon = this.add.image(0, 0, 'sword').setScale(0.5).setVisible(false);
    cursors = this.input.keyboard.createCursorKeys();

    for (let y = 0; y < window.innerHeight; y += 32) {
        for (let x = 0; x < window.innerWidth; x += 32) {
            let material = 'dirt';
            if (y > window.innerHeight * 0.75 && Math.random() < 0.1) material = 'iron';
            else if (y > window.innerHeight * 0.85 && Math.random() < 0.05) material = 'gold';
            else if (y > window.innerHeight * 0.9 && Math.random() < 0.01) material = 'fluorite';
            else if (y > window.innerHeight / 2 - 32) material = 'grass';
            blocks.create(x, y, materials[material].image).setScale(2);
            updateInventory(material, 1);
        }
    }

    for (let i = 0; i < 5; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = window.innerHeight / 2 - 32;
        generateTree(x, y);
    }

    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['water'].image).setScale(2);
    }
    for (let i = 0; i < 2; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(window.innerHeight / 2, window.innerHeight);
        blocks.create(x, y, materials['lava'].image).setScale(2);
    }

    for (let i = 0; i < 3; i++) {
        const x = Phaser.Math.Between(0, window.innerWidth);
        const y = Phaser.Math.Between(0, window.innerHeight / 2);
        const momonga = enemies.create(x, y, 'momonga');
        momonga.setData('hp', 18);
    }

    this.input.on('pointerdown', (pointer) => {
        const x = Math.floor(pointer.x / 32) * 32;
        const y = Math.floor(pointer.y / 32) * 32;
        if (placing) {
            blocks.create(x, y, 'dirt').setScale(2);
            updateInventory('dirt', 1);
        } else {
            const block = blocks.getChildren().find(b => b.x === x && b.y === y);
            if (block) {
                const material = Object.keys(materials).find(key => materials[key].image === block.texture.key);
                if (material) updateInventory(material, -1);
                block.destroy();
            }
        }
    });

    this.input.keyboard.on('keydown-W', () => placing = !placing);

    document.getElementById('left').addEventListener('touchstart', () => player.setVelocityX(-200));
    document.getElementById('right').addEventListener('touchstart', () => player.setVelocityX(200));
    document.getElementById('up').addEventListener('touchstart', () => player.setVelocityY(-200));
    document.getElementById('down').addEventListener('touchstart', () => player.setVelocityY(200));
    document.getElementById('toggle').addEventListener('touchstart', () => placing = !placing);
    document.getElementById('craft').addEventListener('touchstart', () => {
        const craftedItem = craft();
        if (craftedItem) {
            console.log(`${craftedItem}がクラフトされました！`);
            if (craftedItem === 'cardboard') updateInventory('cardboard', 1);
            else if (craftedItem === 'Wiper') {
                currentWeapon = 'Wiper';
                weapon.setTexture('Wiper').setVisible(true);
            } else if (craftedItem.includes('_sword')) {
                currentWeapon = craftedItem;
                weapon.setTexture('sword').setVisible(true);
            }
        } else {
            console.log('材料が足りません。');
        }
    });

    this.input.on('pointerdown', (pointer) => {
        if (currentWeapon) {
            const x = Math.floor(pointer.x / 32) * 32;
            const y = Math.floor(pointer.y / 32) * 32;
            attack(x, y);
        }
    });
}

function update() {
    if (cursors.left.isDown) player.setVelocityX(-160);
    else if (cursors.right.isDown) player.setVelocityX(160);
    else player.setVelocityX(0);

    if (cursors.up.isDown) player.setVelocityY(-160);
    else if (cursors.down.isDown) player.setVelocityY(160);
    else player.setVelocityY(0);
}

function generateTree(x, y) {
    blocks.create(x, y, 'wood').setScale(2);
    blocks.create(x, y - 32, 'wood').setScale(2);
    blocks.create(x, y - 64, 'wood').setScale(2);
    blocks.create(x - 16, y - 32, 'wood').setScale(2);
    blocks.create(x + 16, y - 32, 'wood').setScale(2);
}

function updateInventory(item, quantity) {
    if (!inventory[item]) inventory[item] = 0;
    inventory[item] += quantity;
    renderInventory();
}

function renderInventory() {
    const list = document.getElementById('inventory-list');
    list.innerHTML = '';
    for (const item in inventory) {
        const li = document.createElement('li');
        li.textContent = `${item}: ${inventory[item]}`;
        list.appendChild(li);
    }
}

function craft() {
    for (const recipe in recipes) {
        const needed = recipes[recipe];
        const hasAllMaterials = Object.entries(needed).every(([material, qty]) => inventory[material] >= qty);
        if (hasAllMaterials) {
            for (const [material, qty] of Object.entries(needed)) {
                updateInventory(material, -qty);
            }
            return recipe;
        }
    }
    return null;
}

function attack(x, y) {
    if (currentWeapon) {
        enemies.getChildren().forEach(momonga => {
            if (momonga.getBounds().contains(x, y)) {
                let hp = momonga.getData('hp');
                hp -= weapon.type === 'sword' ? 10 : 5; // Example damage values
                momonga.setData('hp', hp);
                if (hp <= 0) momonga.destroy();
            }
        });
    }
}
</script>
</body>
</html>
